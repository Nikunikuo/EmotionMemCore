{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">
            <i class="bi bi-gear text-primary"></i>
            æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
        </h2>
        <p class="lead text-muted">
            EmotionMemCoreã®æ©Ÿèƒ½ã‚’ç°¡å˜ã«ãƒ†ã‚¹ãƒˆã§ãã¾ã™ã€‚åˆå¿ƒè€…ã®æ–¹ã§ã‚‚å®‰å¿ƒã—ã¦ãŠè©¦ã—ãã ã•ã„ã€‚
        </p>
    </div>
</div>

<!-- ãƒ†ã‚¹ãƒˆè¨˜æ†¶ä¿å­˜ -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="stats-card">
            <h4 class="mb-3">
                <i class="bi bi-plus-circle text-success"></i>
                è¨˜æ†¶ä¿å­˜ãƒ†ã‚¹ãƒˆ
            </h4>
            <p class="text-muted mb-4">
                ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨AIã®ä¼šè©±ã‚’å…¥åŠ›ã—ã¦ã€è¨˜æ†¶ã¨ã—ã¦ä¿å­˜ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
                æ„Ÿæƒ…åˆ†æã¨è¦ç´„ãŒè‡ªå‹•ã§ç”Ÿæˆã•ã‚Œã¾ã™ã€‚
            </p>
            
            <form id="testSaveForm">
                <div class="mb-3">
                    <label for="userMessage" class="form-label">
                        <i class="bi bi-person-fill"></i>
                        ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                    </label>
                    <textarea 
                        class="form-control" 
                        id="userMessage" 
                        name="user_message" 
                        rows="3" 
                        placeholder="ä¾‹: ä»Šæ—¥ã¯ã¨ã¦ã‚‚è‰¯ã„å¤©æ°—ã§ã™ã­ï¼æ•£æ­©ã«è¡Œã“ã†ã‹ãªã€‚"
                        required
                    ></textarea>
                </div>
                
                <div class="mb-3">
                    <label for="aiMessage" class="form-label">
                        <i class="bi bi-robot"></i>
                        AIå¿œç­”ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                    </label>
                    <textarea 
                        class="form-control" 
                        id="aiMessage" 
                        name="ai_message" 
                        rows="3" 
                        placeholder="ä¾‹: æœ¬å½“ã«ã„ã„å¤©æ°—ã§ã™ã­ï¼æ•£æ­©ã¯æ°—æŒã¡ãŒè‰¯ã•ãã†ã§ã™ã€‚ã©ã¡ã‚‰ã«è¡Œã‹ã‚Œã¾ã™ã‹ï¼Ÿ"
                        required
                    ></textarea>
                </div>
                
                <div class="mb-3">
                    <label for="userId" class="form-label">
                        <i class="bi bi-person-badge"></i>
                        ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
                    </label>
                    <input 
                        type="text" 
                        class="form-control" 
                        id="userId" 
                        name="user_id" 
                        value="test_user_001" 
                        placeholder="test_user_001"
                    >
                    <div class="form-text">
                        ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã§ã™ã€‚è‡ªç”±ã«å¤‰æ›´ã§ãã¾ã™ã€‚
                    </div>
                </div>
                
                <button type="submit" class="btn btn-success btn-lg">
                    <i class="bi bi-save"></i>
                    è¨˜æ†¶ã‚’ä¿å­˜ã—ã¦ãƒ†ã‚¹ãƒˆ
                </button>
            </form>
        </div>
    </div>
    
    <!-- ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ -->
    <div class="col-lg-4">
        <div class="stats-card">
            <h5 class="mb-3">
                <i class="bi bi-lightbulb text-warning"></i>
                ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
            </h5>
            <p class="small text-muted mb-3">
                ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ãŒå…¥åŠ›ã•ã‚Œã¾ã™ã€‚
            </p>
            
            <div class="d-grid gap-2">
                <button class="btn btn-outline-primary btn-sm" onclick="loadSample(1)">
                    ğŸ˜Š æ¥½ã—ã„ä¼šè©±
                </button>
                <button class="btn btn-outline-primary btn-sm" onclick="loadSample(2)">
                    ğŸ˜¢ æ‚²ã—ã„è©±
                </button>
                <button class="btn btn-outline-primary btn-sm" onclick="loadSample(3)">
                    ğŸ˜® é©šãã®å‡ºæ¥äº‹
                </button>
                <button class="btn btn-outline-primary btn-sm" onclick="loadSample(4)">
                    â¤ï¸ æ„Ÿè¬ã®æ°—æŒã¡
                </button>
            </div>
            
            <hr>
            
            <h6 class="mb-2">
                <i class="bi bi-info-circle"></i>
                ãƒ’ãƒ³ãƒˆ
            </h6>
            <ul class="small text-muted">
                <li>æ„Ÿæƒ…è±Šã‹ãªå†…å®¹ã»ã©ã€ã‚ˆã‚Šè©³ç´°ãªåˆ†æçµæœãŒå¾—ã‚‰ã‚Œã¾ã™</li>
                <li>æ—¥æœ¬èªã®æ–‡ç« ã§æœ€è‰¯ã®çµæœãŒå¾—ã‚‰ã‚Œã¾ã™</li>
                <li>çŸ­ã™ãã‚‹æ–‡ç« ã‚ˆã‚Šã‚‚ã€é©åº¦ãªé•·ã•ã®æ–¹ãŒè‰¯ã„çµæœã«ãªã‚Šã¾ã™</li>
            </ul>
        </div>
    </div>
</div>

<!-- ãƒ†ã‚¹ãƒˆçµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
<div class="row">
    <div class="col-12">
        <div id="testResults" style="display: none;">
            <div class="stats-card">
                <h4 class="mb-3">
                    <i class="bi bi-check-circle text-success"></i>
                    ãƒ†ã‚¹ãƒˆçµæœ
                </h4>
                <div id="testResultContent"></div>
            </div>
        </div>
    </div>
</div>

<!-- ã‚·ã‚¹ãƒ†ãƒ æ¥ç¶šãƒ†ã‚¹ãƒˆ -->
<div class="row mt-4">
    <div class="col-12">
        <div class="stats-card">
            <h4 class="mb-3">
                <i class="bi bi-wifi text-info"></i>
                ã‚·ã‚¹ãƒ†ãƒ æ¥ç¶šãƒ†ã‚¹ãƒˆ
            </h4>
            <p class="text-muted mb-4">
                EmotionMemCoreã®å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚
            </p>
            
            <div class="row">
                <div class="col-md-3 mb-3">
                    <button class="btn btn-outline-info w-100" onclick="testConnection()">
                        <i class="bi bi-arrow-repeat"></i>
                        æ¥ç¶šãƒ†ã‚¹ãƒˆ
                    </button>
                </div>
                <div class="col-md-3 mb-3">
                    <button class="btn btn-outline-info w-100" onclick="testHealth()">
                        <i class="bi bi-heart-pulse"></i>
                        ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
                    </button>
                </div>
                <div class="col-md-3 mb-3">
                    <button class="btn btn-outline-info w-100" onclick="testSearch()">
                        <i class="bi bi-search"></i>
                        æ¤œç´¢ãƒ†ã‚¹ãƒˆ
                    </button>
                </div>
                <div class="col-md-3 mb-3">
                    <button class="btn btn-outline-info w-100" onclick="testMemories()">
                        <i class="bi bi-journal"></i>
                        è¨˜æ†¶ä¸€è¦§ãƒ†ã‚¹ãƒˆ
                    </button>
                </div>
            </div>
            
            <div id="systemTestResults" class="mt-4"></div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿
    const samples = {
        1: {
            user: "ä»Šæ—¥ã¯å‹é”ã¨æ˜ ç”»ã‚’è¦‹ã«è¡Œãã¾ã—ãŸï¼ã¨ã¦ã‚‚é¢ç™½ãã¦ã€ã¿ã‚“ãªã§å¤§ç¬‘ã„ã—ã¾ã—ãŸã€‚",
            ai: "æ˜ ç”»é‘‘è³ã€æ¥½ã—ãã†ã§ã™ã­ï¼ã©ã‚“ãªã‚¸ãƒ£ãƒ³ãƒ«ã®æ˜ ç”»ã ã£ãŸã‚“ã§ã™ã‹ï¼Ÿå‹é”ã¨ä¸€ç·’ã ã¨æ›´ã«æ¥½ã—ããªã‚Šã¾ã™ã‚ˆã­ã€‚",
            user_id: "happy_user"
        },
        2: {
            user: "ãƒšãƒƒãƒˆãŒäº¡ããªã£ã¦ã—ã¾ã£ã¦ã€ã¨ã¦ã‚‚æ‚²ã—ã„ã§ã™...",
            ai: "ãŠè¾›ã„ãŠæ°—æŒã¡ã€ãŠå¯Ÿã—ã—ã¾ã™ã€‚ãƒšãƒƒãƒˆã¨ã®åˆ¥ã‚Œã¯ã¨ã¦ã‚‚è¾›ã„ã‚‚ã®ã§ã™ã­ã€‚ãã£ã¨ç´ æ•µãªæ€ã„å‡ºãŒãŸãã•ã‚“ã‚ã£ãŸã“ã¨ã§ã—ã‚‡ã†ã€‚",
            user_id: "sad_user"
        },
        3: {
            user: "ã¾ã•ã‹å®ãã˜ãŒå½“ãŸã‚‹ãªã‚“ã¦ï¼ä¿¡ã˜ã‚‰ã‚Œã¾ã›ã‚“ï¼",
            ai: "ã‚ã‚ã€ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼å®ãã˜ãŒå½“ãŸã‚‹ãªã‚“ã¦æœ¬å½“ã«é©šãã§ã™ã­ã€‚ãã£ã¨è‰¯ã„ã“ã¨ã«ä½¿ã‚ã‚Œã‚‹ã“ã¨ã§ã—ã‚‡ã†ã€‚",
            user_id: "surprised_user"
        },
        4: {
            user: "ã„ã¤ã‚‚ã‚µãƒãƒ¼ãƒˆã—ã¦ãã‚Œã¦ã€æœ¬å½“ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚æ„Ÿè¬ã®æ°—æŒã¡ã§ã„ã£ã±ã„ã§ã™ã€‚",
            ai: "ã“ã¡ã‚‰ã“ãã€ã„ã¤ã‚‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ãŠå½¹ã«ç«‹ã¦ã¦å¬‰ã—ã„ã§ã™ã€‚ã“ã‚Œã‹ã‚‰ã‚‚ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ã€‚",
            user_id: "grateful_user"
        }
    };

    // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
    function loadSample(index) {
        const sample = samples[index];
        if (sample) {
            document.getElementById('userMessage').value = sample.user;
            document.getElementById('aiMessage').value = sample.ai;
            document.getElementById('userId').value = sample.user_id;
            
            showAlert('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ', 'info', 2000);
        }
    }

    // è¨˜æ†¶ä¿å­˜ãƒ†ã‚¹ãƒˆ
    document.getElementById('testSaveForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...';
        submitBtn.disabled = true;
        
        try {
            const formData = new FormData(e.target);
            
            const response = await fetch('/api/test-save', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                showTestResult(result);
                showAlert('è¨˜æ†¶ä¿å­˜ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼', 'success');
                
                // ãƒ•ã‚©ãƒ¼ãƒ ãƒªã‚»ãƒƒãƒˆ
                e.target.reset();
                document.getElementById('userId').value = 'test_user_001';
            } else {
                showAlert(`ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${result.error}`, 'danger');
            }
            
        } catch (error) {
            showAlert(`é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'danger');
        } finally {
            // ãƒœã‚¿ãƒ³å¾©å…ƒ
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    });

    // ãƒ†ã‚¹ãƒˆçµæœè¡¨ç¤º
    function showTestResult(result) {
        const resultDiv = document.getElementById('testResults');
        const contentDiv = document.getElementById('testResultContent');
        
        if (result.result) {
            const emotions = result.result.emotions || [];
            const emotionTags = emotions.map(emotion => 
                `<span class="emotion-tag">${emotion}</span>`
            ).join('');
            
            contentDiv.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="bi bi-key"></i> è¨˜æ†¶ID</h6>
                        <p class="text-muted"><code>${result.result.memory_id || 'N/A'}</code></p>
                        
                        <h6><i class="bi bi-journal-text"></i> è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸè¦ç´„</h6>
                        <p class="bg-light p-3 rounded">${result.result.summary || 'è¦ç´„ã‚’ç”Ÿæˆä¸­...'}</p>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="bi bi-emoji-smile"></i> æ¤œå‡ºã•ã‚ŒãŸæ„Ÿæƒ…</h6>
                        <div class="mb-3">${emotionTags || '<span class="text-muted">æ„Ÿæƒ…åˆ†æä¸­...</span>'}</div>
                        
                        <h6><i class="bi bi-info-circle"></i> çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</h6>
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i>
                            ${result.message}
                        </div>
                    </div>
                </div>
                
                <div class="mt-3 p-3 bg-info bg-opacity-10 rounded">
                    <h6><i class="bi bi-lightbulb"></i> æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—</h6>
                    <ul class="mb-0">
                        <li><a href="/search">è¨˜æ†¶æ¤œç´¢ãƒšãƒ¼ã‚¸</a>ã§ã€ä»Šä¿å­˜ã—ãŸè¨˜æ†¶ã‚’æ¤œç´¢ã—ã¦ã¿ã¾ã—ã‚‡ã†</li>
                        <li><a href="/memories">è¨˜æ†¶ç®¡ç†ãƒšãƒ¼ã‚¸</a>ã§ã€ä¿å­˜ã•ã‚ŒãŸè¨˜æ†¶ã®ä¸€è¦§ã‚’ç¢ºèªã§ãã¾ã™</li>
                        <li>ã‚ˆã‚Šå¤šãã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã§ã€æ„Ÿæƒ…åˆ†æã®ç²¾åº¦ã‚’ç¢ºèªã—ã¦ã¿ã¦ãã ã•ã„</li>
                    </ul>
                </div>
            `;
        } else {
            contentDiv.innerHTML = `
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    è©³ç´°ãªçµæœæƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸãŒã€å‡¦ç†ã¯æˆåŠŸã—ã¾ã—ãŸã€‚
                </div>
            `;
        }
        
        resultDiv.style.display = 'block';
        resultDiv.scrollIntoView({ behavior: 'smooth' });
    }

    // ã‚·ã‚¹ãƒ†ãƒ æ¥ç¶šãƒ†ã‚¹ãƒˆ
    async function testConnection() {
        showSystemTestResult('æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...', 'info');
        
        try {
            const response = await fetch('http://localhost:8000/');
            if (response.ok) {
                showSystemTestResult('âœ… API ã‚µãƒ¼ãƒãƒ¼ã¸ã®æ¥ç¶šãŒæˆåŠŸã—ã¾ã—ãŸ', 'success');
            } else {
                showSystemTestResult(`âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼: HTTP ${response.status}`, 'danger');
            }
        } catch (error) {
            showSystemTestResult(`âŒ æ¥ç¶šå¤±æ•—: ${error.message}`, 'danger');
        }
    }

    async function testHealth() {
        showSystemTestResult('ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­...', 'info');
        
        try {
            const response = await fetch('http://localhost:8000/health/');
            const data = await response.json();
            
            if (data.status === 'healthy') {
                showSystemTestResult('âœ… ã‚·ã‚¹ãƒ†ãƒ ã¯æ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™', 'success');
            } else {
                showSystemTestResult(`âš ï¸ ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹: ${data.status}`, 'warning');
            }
        } catch (error) {
            showSystemTestResult(`âŒ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å¤±æ•—: ${error.message}`, 'danger');
        }
    }

    async function testSearch() {
        showSystemTestResult('æ¤œç´¢æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆä¸­...', 'info');
        
        try {
            const response = await fetch('http://localhost:8000/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    query: 'ãƒ†ã‚¹ãƒˆ',
                    user_id: 'test_user',
                    top_k: 1
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                showSystemTestResult(`âœ… æ¤œç´¢æ©Ÿèƒ½ãŒæ­£å¸¸ã§ã™ (${data.results?.length || 0}ä»¶ã®çµæœ)`, 'success');
            } else {
                showSystemTestResult(`âŒ æ¤œç´¢ãƒ†ã‚¹ãƒˆå¤±æ•—: HTTP ${response.status}`, 'danger');
            }
        } catch (error) {
            showSystemTestResult(`âŒ æ¤œç´¢ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'danger');
        }
    }

    async function testMemories() {
        showSystemTestResult('è¨˜æ†¶ä¸€è¦§ãƒ†ã‚¹ãƒˆä¸­...', 'info');
        
        try {
            const response = await fetch('http://localhost:8000/memories?user_id=test_user&limit=1');
            
            if (response.ok) {
                const data = await response.json();
                showSystemTestResult(`âœ… è¨˜æ†¶ä¸€è¦§æ©Ÿèƒ½ãŒæ­£å¸¸ã§ã™ (${data.memories?.length || 0}ä»¶)`, 'success');
            } else {
                showSystemTestResult(`âŒ è¨˜æ†¶ä¸€è¦§ãƒ†ã‚¹ãƒˆå¤±æ•—: HTTP ${response.status}`, 'danger');
            }
        } catch (error) {
            showSystemTestResult(`âŒ è¨˜æ†¶ä¸€è¦§ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'danger');
        }
    }

    function showSystemTestResult(message, type) {
        const resultsDiv = document.getElementById('systemTestResults');
        const alertClass = type === 'success' ? 'alert-success' : 
                          type === 'warning' ? 'alert-warning' : 
                          type === 'danger' ? 'alert-danger' : 'alert-info';
        
        resultsDiv.innerHTML = `
            <div class="alert ${alertClass}">
                ${message}
            </div>
        `;
    }
</script>
{% endblock %}