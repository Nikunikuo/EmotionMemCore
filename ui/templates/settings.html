{% extends "base.html" %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4">
            <i class="bi bi-sliders text-primary"></i>
            設定ガイド
        </h2>
        <p class="lead text-muted">
            EmotionMemCoreの設定を分かりやすくガイドします。初心者でも安心して設定できます。
        </p>
    </div>
</div>

<!-- 設定ステップガイド -->
<div class="row mb-4">
    <div class="col-12">
        <div class="stats-card">
            <h4 class="mb-3">
                <i class="bi bi-list-check text-success"></i>
                設定完了チェックリスト
            </h4>
            <div class="progress-container">
                <div class="progress mb-3">
                    <div class="progress-bar bg-success" id="overallProgress" style="width: 60%"></div>
                </div>
                <div class="text-center">
                    <small class="text-muted">設定完了率: <span id="progressText">60%</span></small>
                </div>
            </div>
            
            <div class="checklist">
                <div class="checklist-item completed" id="step1">
                    <i class="bi bi-check-circle-fill text-success"></i>
                    <div class="checklist-content">
                        <h6>✅ 基本環境設定</h6>
                        <p>Python環境とEmotionMemCoreのインストール</p>
                    </div>
                </div>
                
                <div class="checklist-item completed" id="step2">
                    <i class="bi bi-check-circle-fill text-success"></i>
                    <div class="checklist-content">
                        <h6>✅ 開発モード起動</h6>
                        <p>モックモードでの基本動作確認</p>
                    </div>
                </div>
                
                <div class="checklist-item pending" id="step3">
                    <i class="bi bi-circle text-warning"></i>
                    <div class="checklist-content">
                        <h6>⏳ APIキー設定</h6>
                        <p>OpenAI・Claude APIキーの設定（本格運用時）</p>
                        <button class="btn btn-sm btn-primary" onclick="showApiKeyGuide()">設定ガイド</button>
                    </div>
                </div>
                
                <div class="checklist-item pending" id="step4">
                    <i class="bi bi-circle text-warning"></i>
                    <div class="checklist-content">
                        <h6>⏳ セキュリティ設定</h6>
                        <p>認証・レート制限の設定</p>
                        <button class="btn btn-sm btn-primary" onclick="showSecurityGuide()">設定ガイド</button>
                    </div>
                </div>
                
                <div class="checklist-item pending" id="step5">
                    <i class="bi bi-circle text-muted"></i>
                    <div class="checklist-content">
                        <h6>📦 本番デプロイ</h6>
                        <p>Docker・本番環境への展開</p>
                        <button class="btn btn-sm btn-outline-primary" onclick="showDeployGuide()">デプロイガイド</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 現在の設定表示 -->
<div class="row mb-4">
    <div class="col-lg-6 mb-4">
        <div class="stats-card">
            <h5 class="mb-3">
                <i class="bi bi-gear text-info"></i>
                現在の設定
            </h5>
            <div class="settings-display">
                <div class="setting-item">
                    <div class="setting-label">環境モード</div>
                    <div class="setting-value">
                        <span class="badge bg-info">{{ current_settings.environment }}</span>
                    </div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">デバッグモード</div>
                    <div class="setting-value">
                        <span class="badge {% if current_settings.debug_mode == 'true' %}bg-warning{% else %}bg-secondary{% endif %}">
                            {{ current_settings.debug_mode }}
                        </span>
                    </div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">LLMモックモード</div>
                    <div class="setting-value">
                        <span class="badge {% if current_settings.llm_mock_mode == 'true' %}bg-success{% else %}bg-danger{% endif %}">
                            {{ current_settings.llm_mock_mode }}
                        </span>
                    </div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">認証有効</div>
                    <div class="setting-value">
                        <span class="badge {% if current_settings.auth_enabled == 'true' %}bg-success{% else %}bg-warning{% endif %}">
                            {{ current_settings.auth_enabled }}
                        </span>
                    </div>
                </div>
                
                <div class="setting-item">
                    <div class="setting-label">レート制限</div>
                    <div class="setting-value">
                        <span class="badge {% if current_settings.rate_limit_enabled == 'true' %}bg-success{% else %}bg-warning{% endif %}">
                            {{ current_settings.rate_limit_enabled }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6 mb-4">
        <div class="stats-card">
            <h5 class="mb-3">
                <i class="bi bi-speedometer2 text-success"></i>
                システム状態
            </h5>
            <div id="systemStatus">
                <div class="status-item">
                    <div class="status-indicator status-healthy"></div>
                    <div class="status-content">
                        <div class="status-title">メインAPI</div>
                        <div class="status-desc" id="apiStatus">接続チェック中...</div>
                    </div>
                </div>
                
                <div class="status-item">
                    <div class="status-indicator status-healthy"></div>
                    <div class="status-content">
                        <div class="status-title">ダッシュボード</div>
                        <div class="status-desc">正常稼働中</div>
                    </div>
                </div>
                
                <div class="status-item">
                    <div class="status-indicator status-warning"></div>
                    <div class="status-content">
                        <div class="status-title">本番準備度</div>
                        <div class="status-desc">60% - 開発段階</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 設定変更フォーム -->
<div class="row mb-4">
    <div class="col-12">
        <div class="stats-card">
            <h5 class="mb-3">
                <i class="bi bi-wrench text-warning"></i>
                設定変更
            </h5>
            <p class="text-muted mb-4">
                ⚠️ 設定変更後は、メインAPIサーバーとダッシュボードの再起動が必要です。
            </p>
            
            <form id="settingsForm">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="environmentSelect" class="form-label">
                            <i class="bi bi-globe"></i>
                            環境モード
                        </label>
                        <select class="form-select" id="environmentSelect" name="environment">
                            <option value="development" {% if current_settings.environment == 'development' %}selected{% endif %}>
                                開発環境 (development)
                            </option>
                            <option value="staging" {% if current_settings.environment == 'staging' %}selected{% endif %}>
                                ステージング環境 (staging)
                            </option>
                            <option value="production" {% if current_settings.environment == 'production' %}selected{% endif %}>
                                本番環境 (production)
                            </option>
                        </select>
                        <div class="form-text">開発・テスト段階では "development" を推奨</div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="debugModeSelect" class="form-label">
                            <i class="bi bi-bug"></i>
                            デバッグモード
                        </label>
                        <select class="form-select" id="debugModeSelect" name="debug_mode">
                            <option value="true" {% if current_settings.debug_mode == 'true' %}selected{% endif %}>
                                有効 (詳細ログ出力)
                            </option>
                            <option value="false" {% if current_settings.debug_mode == 'false' %}selected{% endif %}>
                                無効 (通常ログ)
                            </option>
                        </select>
                        <div class="form-text">問題解決時は有効にすると詳細情報が取得できます</div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="mockModeSelect" class="form-label">
                            <i class="bi bi-robot"></i>
                            LLMモックモード
                        </label>
                        <select class="form-select" id="mockModeSelect" name="llm_mock_mode">
                            <option value="true" {% if current_settings.llm_mock_mode == 'true' %}selected{% endif %}>
                                有効 (APIキー不要)
                            </option>
                            <option value="false" {% if current_settings.llm_mock_mode == 'false' %}selected{% endif %}>
                                無効 (実際のAPI使用)
                            </option>
                        </select>
                        <div class="form-text">初期テストではモックモードを推奨</div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="authSelect" class="form-label">
                            <i class="bi bi-shield-check"></i>
                            認証機能
                        </label>
                        <select class="form-select" id="authSelect" name="auth_enabled">
                            <option value="false" {% if current_settings.auth_enabled == 'false' %}selected{% endif %}>
                                無効 (開発・テスト用)
                            </option>
                            <option value="true" {% if current_settings.auth_enabled == 'true' %}selected{% endif %}>
                                有効 (本番運用)
                            </option>
                        </select>
                        <div class="form-text">本番運用時は必ず有効にしてください</div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="rateLimitSelect" class="form-label">
                            <i class="bi bi-speedometer"></i>
                            レート制限
                        </label>
                        <select class="form-select" id="rateLimitSelect" name="rate_limit_enabled">
                            <option value="false" {% if current_settings.rate_limit_enabled == 'false' %}selected{% endif %}>
                                無効 (開発・テスト用)
                            </option>
                            <option value="true" {% if current_settings.rate_limit_enabled == 'true' %}selected{% endif %}>
                                有効 (DoS攻撃対策)
                            </option>
                        </select>
                        <div class="form-text">本番運用時は必ず有効にしてください</div>
                    </div>
                    
                    <div class="col-md-6 mb-3">
                        <label for="logLevelSelect" class="form-label">
                            <i class="bi bi-journal-text"></i>
                            ログレベル
                        </label>
                        <select class="form-select" id="logLevelSelect" name="log_level">
                            <option value="DEBUG">DEBUG (全てのログ)</option>
                            <option value="INFO" selected>INFO (通常情報)</option>
                            <option value="WARNING">WARNING (警告以上)</option>
                            <option value="ERROR">ERROR (エラーのみ)</option>
                        </select>
                        <div class="form-text">開発時はINFO、問題発生時はDEBUGを推奨</div>
                    </div>
                </div>
                
                <div class="mt-4">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-lg"></i>
                        設定を保存
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="resetToDefaults()">
                        <i class="bi bi-arrow-clockwise"></i>
                        デフォルトに戻す
                    </button>
                    <button type="button" class="btn btn-info" onclick="exportSettings()">
                        <i class="bi bi-download"></i>
                        設定をエクスポート
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- クイックアクション -->
<div class="row">
    <div class="col-lg-4 col-md-6 mb-3">
        <div class="quick-action-card">
            <div class="icon text-primary">
                <i class="bi bi-play-circle"></i>
            </div>
            <h5>即座に試す</h5>
            <p>設定変更なしで今すぐ EmotionMemCore を体験</p>
            <a href="/test" class="btn btn-primary">機能テストへ</a>
        </div>
    </div>
    
    <div class="col-lg-4 col-md-6 mb-3">
        <div class="quick-action-card">
            <div class="icon text-success">
                <i class="bi bi-book"></i>
            </div>
            <h5>詳細ガイド</h5>
            <p>ステップバイステップの詳細設定ガイド</p>
            <button class="btn btn-success" onclick="showDetailedGuide()">ガイドを開く</button>
        </div>
    </div>
    
    <div class="col-lg-4 col-md-6 mb-3">
        <div class="quick-action-card">
            <div class="icon text-warning">
                <i class="bi bi-question-circle"></i>
            </div>
            <h5>トラブルシュート</h5>
            <p>問題が発生した時の解決方法</p>
            <button class="btn btn-warning" onclick="showTroubleshooting()">問題解決ガイド</button>
        </div>
    </div>
</div>

<!-- モーダル: APIキー設定ガイド -->
<div class="modal fade" id="apiKeyModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-key"></i>
                    APIキー設定ガイド
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <h6>🔑 必要なAPIキー</h6>
                    <div class="alert alert-info">
                        <strong>開発・テスト段階では設定不要です！</strong><br>
                        モックモードで全機能をお試しいただけます。
                    </div>
                    
                    <div class="api-key-section">
                        <h6>1. OpenAI API キー（必須）</h6>
                        <p>記憶のベクトル化（Embedding）に使用します。</p>
                        <ul>
                            <li><a href="https://platform.openai.com/api-keys" target="_blank">OpenAI API Keys</a> で取得</li>
                            <li>月額約$1-5程度の利用料金</li>
                            <li>text-embedding-3-small モデルを使用</li>
                        </ul>
                        
                        <h6 class="mt-3">2. Anthropic API キー（推奨）</h6>
                        <p>Claude による記憶の要約・感情分析に使用します。</p>
                        <ul>
                            <li><a href="https://console.anthropic.com/" target="_blank">Anthropic Console</a> で取得</li>
                            <li>Claude 3 Haiku モデルを使用（高速・低コスト）</li>
                            <li>GPT代替も可能（設定で切り替え）</li>
                        </ul>
                    </div>
                    
                    <h6>📝 設定方法</h6>
                    <div class="code-block">
                        <pre><code># .env ファイルに追加
OPENAI_API_KEY=sk-your-openai-api-key
ANTHROPIC_API_KEY=sk-ant-api-your-claude-key

# モックモードを無効化
LLM_MOCK_MODE=false</code></pre>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="markStepCompleted('step3')">
                    設定完了
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    後で設定
                </button>
            </div>
        </div>
    </div>
</div>

<!-- モーダル: セキュリティ設定ガイド -->
<div class="modal fade" id="securityModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-shield-check"></i>
                    セキュリティ設定ガイド
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <div class="alert alert-warning">
                        <strong>本番運用時のみ必要です！</strong><br>
                        開発・テスト段階では設定不要です。
                    </div>
                    
                    <h6>🛡️ 必須セキュリティ設定</h6>
                    
                    <div class="security-section">
                        <h6>1. API認証の有効化</h6>
                        <div class="code-block">
                            <pre><code># .env ファイルに追加
AUTH_ENABLED=true
MASTER_API_KEY=your-secure-master-key-here</code></pre>
                        </div>
                        <p>強力なマスターAPIキーを設定してください（32文字以上推奨）</p>
                        
                        <h6 class="mt-3">2. レート制限の設定</h6>
                        <div class="code-block">
                            <pre><code># DoS攻撃対策
RATE_LIMIT_ENABLED=true
RATE_LIMIT_RPM=60    # 分間リクエスト数
RATE_LIMIT_RPH=1000  # 時間リクエスト数</code></pre>
                        </div>
                        
                        <h6 class="mt-3">3. CORS設定</h6>
                        <div class="code-block">
                            <pre><code># 許可するドメインを指定
CORS_ALLOWED_ORIGINS=https://yourdomain.com,https://app.yourdomain.com</code></pre>
                        </div>
                        
                        <h6 class="mt-3">4. HTTPS化</h6>
                        <p>本番環境では必ずHTTPS通信を使用してください。</p>
                        <ul>
                            <li>Let's Encrypt等でSSL証明書を取得</li>
                            <li>リバースプロキシ（nginx）でHTTPS終端</li>
                            <li>セキュリティヘッダーの設定</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="markStepCompleted('step4')">
                    設定完了
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    後で設定
                </button>
            </div>
        </div>
    </div>
</div>

<!-- モーダル: デプロイガイド -->
<div class="modal fade" id="deployModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-rocket"></i>
                    本番デプロイガイド
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="deploy-guide">
                    <h6>🚀 本番環境へのデプロイ</h6>
                    
                    <div class="step-by-step">
                        <div class="deploy-step">
                            <div class="step-number">1</div>
                            <div class="step-content">
                                <h6>環境変数の準備</h6>
                                <div class="code-block">
                                    <pre><code># production.env ファイル作成
ENVIRONMENT=production
DEBUG_MODE=false
LLM_MOCK_MODE=false

# APIキー設定
OPENAI_API_KEY=sk-your-openai-key
ANTHROPIC_API_KEY=sk-ant-your-claude-key

# セキュリティ設定
AUTH_ENABLED=true
MASTER_API_KEY=your-super-secure-master-key
RATE_LIMIT_ENABLED=true

# CORS設定
CORS_ALLOWED_ORIGINS=https://yourdomain.com</code></pre>
                                </div>
                            </div>
                        </div>
                        
                        <div class="deploy-step">
                            <div class="step-number">2</div>
                            <div class="step-content">
                                <h6>Dockerデプロイ</h6>
                                <div class="code-block">
                                    <pre><code># 本番用Docker起動
docker-compose -f docker-compose.yml --env-file production.env up -d

# ヘルスチェック
curl https://yourdomain.com/health/</code></pre>
                                </div>
                            </div>
                        </div>
                        
                        <div class="deploy-step">
                            <div class="step-number">3</div>
                            <div class="step-content">
                                <h6>監視・ログ設定</h6>
                                <div class="code-block">
                                    <pre><code># ログローテーション設定
sudo logrotate -d /etc/logrotate.d/emotionmemcore

# リソース監視
docker stats</code></pre>
                                </div>
                            </div>
                        </div>
                        
                        <div class="deploy-step">
                            <div class="step-number">4</div>
                            <div class="step-content">
                                <h6>バックアップ設定</h6>
                                <div class="code-block">
                                    <pre><code># 日次バックアップ（crontab）
0 2 * * * curl -X POST https://yourdomain.com/debug/backup/emotion_memories</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-success mt-4">
                        <h6>✅ デプロイ完了後の確認項目</h6>
                        <ul class="mb-0">
                            <li>APIエンドポイントの動作確認</li>
                            <li>認証機能の動作確認</li>
                            <li>レート制限の動作確認</li>
                            <li>ログ出力の確認</li>
                            <li>バックアップ機能の確認</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="markStepCompleted('step5')">
                    デプロイ完了
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    閉じる
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    .progress-container {
        margin-bottom: 2rem;
    }
    
    .checklist {
        list-style: none;
        padding: 0;
    }
    
    .checklist-item {
        display: flex;
        align-items: flex-start;
        padding: 1rem;
        margin-bottom: 0.5rem;
        border-radius: 0.75rem;
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
    }
    
    .checklist-item.completed {
        background: linear-gradient(135deg, #e8f5e8, #f0f8f0);
        border-left-color: #28a745;
    }
    
    .checklist-item.pending {
        background: linear-gradient(135deg, #fff3cd, #fefefe);
        border-left-color: #ffc107;
    }
    
    .checklist-item i {
        font-size: 1.5rem;
        margin-right: 1rem;
        margin-top: 0.25rem;
    }
    
    .checklist-content {
        flex: 1;
    }
    
    .checklist-content h6 {
        margin-bottom: 0.5rem;
        font-weight: 600;
    }
    
    .checklist-content p {
        margin-bottom: 0.5rem;
        color: #666;
    }
    
    .settings-display {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .setting-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 0.5rem;
        border-left: 3px solid #007bff;
    }
    
    .setting-label {
        font-weight: 500;
        color: #333;
    }
    
    .setting-value .badge {
        font-size: 0.8rem;
    }
    
    .status-item {
        display: flex;
        align-items: center;
        padding: 0.75rem 0;
        border-bottom: 1px solid #eee;
    }
    
    .status-item:last-child {
        border-bottom: none;
    }
    
    .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 1rem;
        flex-shrink: 0;
    }
    
    .status-content {
        flex: 1;
    }
    
    .status-title {
        font-weight: 500;
        margin-bottom: 0.25rem;
    }
    
    .status-desc {
        font-size: 0.9rem;
        color: #666;
    }
    
    .quick-action-card {
        background: white;
        border-radius: 1rem;
        padding: 2rem;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
    }
    
    .quick-action-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }
    
    .quick-action-card .icon {
        font-size: 3rem;
        margin-bottom: 1rem;
    }
    
    .quick-action-card h5 {
        margin-bottom: 1rem;
        color: #333;
    }
    
    .quick-action-card p {
        color: #666;
        margin-bottom: 1.5rem;
        flex-grow: 1;
    }
    
    .code-block {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 0.5rem;
        margin: 1rem 0;
    }
    
    .code-block pre {
        margin: 0;
        padding: 1rem;
        background: none;
        border: none;
    }
    
    .api-key-section, .security-section {
        padding: 1rem 0;
    }
    
    .deploy-guide .step-by-step {
        margin: 2rem 0;
    }
    
    .deploy-step {
        display: flex;
        margin-bottom: 2rem;
        padding-bottom: 2rem;
        border-bottom: 1px solid #eee;
    }
    
    .deploy-step:last-child {
        border-bottom: none;
    }
    
    .step-number {
        flex-shrink: 0;
        width: 40px;
        height: 40px;
        background: linear-gradient(45deg, #007bff, #28a745);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 1.5rem;
        margin-top: 0.5rem;
    }
    
    .step-content {
        flex: 1;
    }
    
    .step-content h6 {
        margin-bottom: 1rem;
        color: #333;
    }
    
    @keyframes checkmark {
        0% { transform: scale(0); }
        50% { transform: scale(1.2); }
        100% { transform: scale(1); }
    }
    
    .checklist-item.completed i {
        animation: checkmark 0.5s ease-out;
    }
    
    @media (max-width: 768px) {
        .quick-action-card {
            margin-bottom: 1rem;
        }
        
        .deploy-step {
            flex-direction: column;
        }
        
        .step-number {
            align-self: flex-start;
            margin-bottom: 1rem;
        }
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
    // 現在の設定状態
    let currentProgress = 60; // 初期完了率
    let completedSteps = ['step1', 'step2'];
    
    // ページ読み込み時の初期化
    document.addEventListener('DOMContentLoaded', function() {
        checkApiStatus();
        updateProgress();
        
        // 設定フォームの送信処理
        document.getElementById('settingsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            saveSettings();
        });
    });
    
    // API状態チェック
    async function checkApiStatus() {
        try {
            const response = await fetch('http://localhost:8000/health/');
            const statusElement = document.getElementById('apiStatus');
            
            if (response.ok) {
                statusElement.textContent = '正常稼働中';
                statusElement.parentElement.previousElementSibling.className = 'status-indicator status-healthy';
            } else {
                statusElement.textContent = '接続エラー';
                statusElement.parentElement.previousElementSibling.className = 'status-indicator status-error';
            }
        } catch (error) {
            const statusElement = document.getElementById('apiStatus');
            statusElement.textContent = 'サーバー未起動';
            statusElement.parentElement.previousElementSibling.className = 'status-indicator status-error';
        }
    }
    
    // 進捗更新
    function updateProgress() {
        const progressBar = document.getElementById('overallProgress');
        const progressText = document.getElementById('progressText');
        
        progressBar.style.width = currentProgress + '%';
        progressText.textContent = currentProgress + '%';
        
        // 完了ステップのUI更新
        completedSteps.forEach(stepId => {
            const step = document.getElementById(stepId);
            if (step && !step.classList.contains('completed')) {
                step.classList.remove('pending');
                step.classList.add('completed');
                
                const icon = step.querySelector('i');
                icon.className = 'bi bi-check-circle-fill text-success';
            }
        });
    }
    
    // ステップ完了マーク
    function markStepCompleted(stepId) {
        if (!completedSteps.includes(stepId)) {
            completedSteps.push(stepId);
            currentProgress = Math.min(100, currentProgress + 20);
            updateProgress();
            showAlert('設定ステップが完了しました！', 'success', 3000);
        }
        
        // モーダル閉じる
        const modals = ['apiKeyModal', 'securityModal', 'deployModal'];
        modals.forEach(modalId => {
            const modal = bootstrap.Modal.getInstance(document.getElementById(modalId));
            if (modal) modal.hide();
        });
    }
    
    // APIキーガイド表示
    function showApiKeyGuide() {
        const modal = new bootstrap.Modal(document.getElementById('apiKeyModal'));
        modal.show();
    }
    
    // セキュリティガイド表示
    function showSecurityGuide() {
        const modal = new bootstrap.Modal(document.getElementById('securityModal'));
        modal.show();
    }
    
    // デプロイガイド表示
    function showDeployGuide() {
        const modal = new bootstrap.Modal(document.getElementById('deployModal'));
        modal.show();
    }
    
    // 詳細ガイド表示
    function showDetailedGuide() {
        const guideContent = `
EmotionMemCore 詳細設定ガイド

📚 ステップバイステップガイド:

1. 基本セットアップ
   - Python 3.11+ のインストール確認
   - Poetry または pip での依存関係インストール
   - 基本動作確認

2. 開発環境での利用
   - モックモード有効で APIキー不要
   - ダッシュボードでの動作確認
   - サンプルデータでの機能テスト

3. 本格運用への移行
   - OpenAI APIキー取得・設定
   - Claude APIキー取得・設定（オプション）
   - モックモード無効化

4. セキュリティ強化
   - 認証機能有効化
   - レート制限設定
   - CORS設定

5. 本番デプロイ
   - Docker環境構築
   - HTTPS設定
   - 監視・バックアップ設定

詳細は README.md をご確認ください。
        `;
        
        alert(guideContent);
    }
    
    // トラブルシューティング表示
    function showTroubleshooting() {
        const troubleContent = `
🔧 よくある問題と解決方法

❌ "Connection Error" が表示される
→ メインAPIサーバー (port 8000) が起動しているか確認
→ python main.py でAPIサーバーを起動

❌ APIキーエラーが出る
→ .env ファイルの APIキー設定を確認
→ 開発時は LLM_MOCK_MODE=true でモックモード使用

❌ ポートが使用中エラー
→ lsof -i :8000 でポート使用状況確認
→ 既存プロセスを停止してから再起動

❌ Docker起動エラー
→ docker-compose down でクリーンアップ
→ docker-compose build --no-cache で再ビルド

❌ 記憶保存・検索ができない
→ ChromaDB データディレクトリの権限確認
→ DEBUG_MODE=true で詳細ログ確認

その他の問題は GitHub Issues にご報告ください。
        `;
        
        alert(troubleContent);
    }
    
    // 設定保存
    async function saveSettings() {
        const formData = new FormData(document.getElementById('settingsForm'));
        const settings = Object.fromEntries(formData);
        
        try {
            // 実際の実装では、設定保存 API を呼び出し
            // const response = await fetch('/api/settings', {
            //     method: 'POST',
            //     body: JSON.stringify(settings),
            //     headers: { 'Content-Type': 'application/json' }
            // });
            
            // デモ用の疑似保存
            setTimeout(() => {
                showAlert('設定を保存しました。サーバー再起動後に有効になります。', 'success', 5000);
                
                // UI更新
                updateSettingsDisplay(settings);
            }, 1000);
            
        } catch (error) {
            showAlert('設定保存に失敗しました: ' + error.message, 'danger');
        }
    }
    
    // 設定表示更新
    function updateSettingsDisplay(settings) {
        // 実際の実装では、設定値に応じてバッジの色やステータスを更新
        showAlert('設定表示を更新しました', 'info', 2000);
    }
    
    // デフォルト設定にリセット
    function resetToDefaults() {
        if (confirm('設定をデフォルトに戻しますか？')) {
            document.getElementById('environmentSelect').value = 'development';
            document.getElementById('debugModeSelect').value = 'true';
            document.getElementById('mockModeSelect').value = 'true';
            document.getElementById('authSelect').value = 'false';
            document.getElementById('rateLimitSelect').value = 'false';
            document.getElementById('logLevelSelect').value = 'INFO';
            
            showAlert('設定をデフォルトにリセットしました', 'info', 3000);
        }
    }
    
    // 設定エクスポート
    function exportSettings() {
        const formData = new FormData(document.getElementById('settingsForm'));
        const settings = Object.fromEntries(formData);
        
        const exportData = {
            export_date: new Date().toISOString(),
            emotionmemcore_version: '0.1.0',
            settings: settings
        };
        
        const dataStr = JSON.stringify(exportData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        
        const url = URL.createObjectURL(dataBlob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `emotionmemcore_settings_${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showAlert('設定をエクスポートしました', 'success', 3000);
    }
    
    // アラート表示（再利用可能な共通関数）
    function showAlert(message, type = 'info', duration = 5000) {
        // Bootstrap alert またはカスタムトースト通知の実装
        // 簡易版として alert を使用
        if (type === 'danger' || type === 'error') {
            console.error(message);
        } else {
            console.log(message);
        }
        
        // より良いUXのためには、実際のプロジェクトでtoast通知を実装
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        // 自動消去
        if (duration > 0) {
            setTimeout(() => {
                if (alertDiv.parentElement) {
                    alertDiv.remove();
                }
            }, duration);
        }
    }
</script>
{% endblock %}